<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>購入要求パラメータ検証ツール</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 1.8rem;
      text-align: center;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 1.2rem;
    }

    fieldset {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      margin: 0 0 20px;
      padding: 16px 18px 20px;
      background: #ffffff;
    }

    legend {
      padding: 0 8px;
      font-weight: 700;
      color: #1d4ed8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border-top: 1px solid #e5e7eb;
      padding: 10px 12px;
      vertical-align: top;
    }

    tbody tr:first-child th,
    tbody tr:first-child td {
      border-top: none;
    }

    th {
      width: 220px;
      background: #f9fafb;
      font-weight: 600;
      color: #1f2937;
    }

    .seq {
      display: inline-block;
      min-width: 28px;
      margin-right: 10px;
      font-weight: 700;
      color: #2563eb;
    }

    .requirement-badge {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 700;
      line-height: 1;
      vertical-align: middle;
      border: 1px solid transparent;
    }

    .requirement-badge.req-required {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .requirement-badge.req-conditional {
      background: #fef9c3;
      border-color: #fde68a;
      color: #b45309;
    }

    .requirement-badge.req-optional {
      background: #e0f2fe;
      border-color: #bae6fd;
      color: #0369a1;
    }

    .requirement-legend {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin: 12px 0 16px;
      font-size: 0.85rem;
      color: #4b5563;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 6px;
      border-radius: 999px;
      background: #2563eb;
      color: #ffffff;
      font-size: 0.7rem;
      font-weight: 700;
      cursor: help;
      position: relative;
      transition: box-shadow 0.15s ease;
    }

    .info-icon:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
    }

    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 12px);
      transform: translate(-50%, -6px);
      background: #111827;
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      line-height: 1.5;
      min-width: 200px;
      max-width: 320px;
      white-space: pre-wrap;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 40;
    }

    .info-icon::before {
      content: '';
      position: absolute;
      left: 50%;
      bottom: calc(100% + 6px);
      transform: translate(-50%, -6px);
      border-width: 6px;
      border-style: solid;
      border-color: transparent;
      border-top-color: #111827;
      opacity: 0;
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .info-icon:hover::after,
    .info-icon:focus::after,
    .info-icon:hover::before,
    .info-icon:focus::before {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    label,
    textarea,
    input,
    select {
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea,
    input[type="text"],
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #111827;
    }

    textarea {
      min-height: 54px;
      resize: vertical;
    }

    select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #111827;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .note {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
      line-height: 1.5;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 18px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 9px 20px;
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #ffffff;
    }

    button.secondary {
      background: none;
      color: #1f2937;
      border: 1px solid #94a3b8;
    }

    button.small {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 6px;
    }

    .detail-row {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      background: #f9fafb;
      position: relative;
    }

    .detail-row h3 {
      margin: 0 0 12px;
      font-size: 1rem;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .detail-row button.remove-detail {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #fef2f2;
      color: #b91c1c;
      border-radius: 6px;
      border: 1px solid #fecaca;
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .result-card,
    .helper-card {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 18px;
      margin-top: 20px;
    }

    .result-card h2,
    .helper-card h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    .stack {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .stack > * {
      flex: 1 1 280px;
    }

    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
      font-size: 0.85rem;
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
    }

    .result-table th,
    .result-table td {
      border-top: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
      vertical-align: top;
      font-size: 0.9rem;
    }

    .result-table thead th {
      border-top: none;
      background: #f3f4f6;
      font-weight: 600;
    }

    .inline-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }

    .section-note {
      margin: 4px 0 12px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      th {
        width: auto;
        display: block;
      }

      td {
        display: block;
        border-top: none;
        padding-top: 6px;
      }

      tr {
        margin-bottom: 14px;
        display: block;
        border-top: 1px solid #e5e7eb;
        padding-top: 10px;
      }

      tr:first-child {
        border-top: none;
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
<main>
  <h1>購入要求パラメータ検証ツール</h1>
  <form id="request-form">
    <div class="requirement-legend">
      <span>バッジ凡例：</span>
      <span class="requirement-badge req-required">必須</span>
      <span class="requirement-badge req-conditional">条件付必須</span>
      <span class="requirement-badge req-optional">任意</span>
    </div>
    <fieldset>
      <legend>基本パラメータ（SEQ 1〜28）</legend>
      <table>
        <tbody>
          <tr data-seq="1">
            <th><span class="seq">1</span>pay_method<span class="info-icon" data-note-key="pay_method" tabindex="0" role="img"></span><br><small>支払方法</small></th>
            <td>
              <textarea data-param="pay_method" rows="2" placeholder="例：credit, webcvs"></textarea>
              <p class="note">複数指定はカンマ区切りなど任意の表現で入力してください。</p>
            </td>
          </tr>
          <tr data-seq="2">
            <th><span class="seq">2</span>merchant_id<span class="info-icon" data-note-key="merchant_id" tabindex="0" role="img"></span><br><small>マーチャントID</small></th>
            <td><input type="text" data-param="merchant_id" maxlength="5" placeholder="例：12345"></td>
          </tr>
          <tr data-seq="3">
            <th><span class="seq">3</span>service_id<span class="info-icon" data-note-key="service_id" tabindex="0" role="img"></span><br><small>サービスID</small></th>
            <td><input type="text" data-param="service_id" maxlength="3" placeholder="例：001"></td>
          </tr>
          <tr data-seq="4">
            <th><span class="seq">4</span>cust_code<span class="info-icon" data-note-key="cust_code" tabindex="0" role="img"></span><br><small>顧客ID</small></th>
            <td><input type="text" data-param="cust_code" maxlength="64"></td>
          </tr>
          <tr data-seq="5">
            <th><span class="seq">5</span>sps_cust_no<span class="info-icon" data-note-key="sps_cust_no" tabindex="0" role="img"></span><br><small>SBPS顧客ID</small></th>
            <td><input type="text" data-param="sps_cust_no" maxlength="12"></td>
          </tr>
          <tr data-seq="6">
            <th><span class="seq">6</span>sps_payment_no<span class="info-icon" data-note-key="sps_payment_no" tabindex="0" role="img"></span><br><small>支払方法管理番号</small></th>
            <td><input type="text" data-param="sps_payment_no" maxlength="3"></td>
          </tr>
          <tr data-seq="7">
            <th><span class="seq">7</span>order_id<span class="info-icon" data-note-key="order_id" tabindex="0" role="img"></span><br><small>購入ID</small></th>
            <td><input type="text" data-param="order_id" maxlength="38"></td>
          </tr>
          <tr data-seq="8">
            <th><span class="seq">8</span>item_id<span class="info-icon" data-note-key="item_id" tabindex="0" role="img"></span><br><small>商品ID</small></th>
            <td><input type="text" data-param="item_id" maxlength="32"></td>
          </tr>
          <tr data-seq="9">
            <th><span class="seq">9</span>pay_item_id<span class="info-icon" data-note-key="pay_item_id" tabindex="0" role="img"></span><br><small>外部決済機関商品ID</small></th>
            <td><input type="text" data-param="pay_item_id" maxlength="32"></td>
          </tr>
          <tr data-seq="10">
            <th><span class="seq">10</span>item_name<span class="info-icon" data-note-key="item_name" tabindex="0" role="img"></span><br><small>商品名称</small></th>
            <td><input type="text" data-param="item_name" maxlength="40"></td>
          </tr>
          <tr data-seq="11">
            <th><span class="seq">11</span>tax<span class="info-icon" data-note-key="tax" tabindex="0" role="img"></span><br><small>税額</small></th>
            <td><input type="number" data-param="tax" min="0"></td>
          </tr>
          <tr data-seq="12">
            <th><span class="seq">12</span>amount<span class="info-icon" data-note-key="amount" tabindex="0" role="img"></span><br><small>金額（税込）</small></th>
            <td><input type="number" data-param="amount" min="0"></td>
          </tr>
          <tr data-seq="13">
            <th><span class="seq">13</span>pay_type<span class="info-icon" data-note-key="pay_type" tabindex="0" role="img"></span><br><small>購入タイプ</small></th>
            <td>
              <select data-param="pay_type">
                <option value="">-- 選択してください --</option>
                <option value="0">0：都度課金</option>
                <option value="1">1：継続課金（参考）</option>
              </select>
            </td>
          </tr>
          <tr data-seq="15">
            <th><span class="seq">15</span>service_type<span class="info-icon" data-note-key="service_type" tabindex="0" role="img"></span><br><small>サービスタイプ</small></th>
            <td>
              <select data-param="service_type">
                <option value="">-- 選択してください --</option>
                <option value="0">0：売上（購入）</option>
                <option value="1">1：仮売上（参考）</option>
              </select>
            </td>
          </tr>
          <tr data-seq="20">
            <th><span class="seq">20</span>terminal_type<span class="info-icon" data-note-key="terminal_type" tabindex="0" role="img"></span><br><small>顧客利用端末タイプ</small></th>
            <td>
              <select data-param="terminal_type">
                <option value="">（省略時は0）</option>
                <option value="0">0：PC</option>
                <option value="1">1：フィーチャーフォン</option>
                <option value="2">2：スマートフォン</option>
              </select>
            </td>
          </tr>
          <tr data-seq="21">
            <th><span class="seq">21</span>success_url<span class="info-icon" data-note-key="success_url" tabindex="0" role="img"></span><br><small>決済完了時URL</small></th>
            <td><input type="text" data-param="success_url" placeholder="https://"></td>
          </tr>
          <tr data-seq="22">
            <th><span class="seq">22</span>cancel_url<span class="info-icon" data-note-key="cancel_url" tabindex="0" role="img"></span><br><small>決済キャンセル時URL</small></th>
            <td><input type="text" data-param="cancel_url" placeholder="https://"></td>
          </tr>
          <tr data-seq="23">
            <th><span class="seq">23</span>error_url<span class="info-icon" data-note-key="error_url" tabindex="0" role="img"></span><br><small>エラー時URL</small></th>
            <td><input type="text" data-param="error_url" placeholder="https://"></td>
          </tr>
          <tr data-seq="24">
            <th><span class="seq">24</span>pagecon_url<span class="info-icon" data-note-key="pagecon_url" tabindex="0" role="img"></span><br><small>決済通知用CGI</small></th>
            <td><input type="text" data-param="pagecon_url" placeholder="https://"></td>
          </tr>
          <tr data-seq="25">
            <th><span class="seq">25</span>free1<span class="info-icon" data-note-key="free1" tabindex="0" role="img"></span><br><small>自由欄1</small></th>
            <td><input type="text" data-param="free1" maxlength="20"></td>
          </tr>
          <tr data-seq="26">
            <th><span class="seq">26</span>free2<span class="info-icon" data-note-key="free2" tabindex="0" role="img"></span><br><small>自由欄2</small></th>
            <td><input type="text" data-param="free2" maxlength="20"></td>
          </tr>
          <tr data-seq="27">
            <th><span class="seq">27</span>free3<span class="info-icon" data-note-key="free3" tabindex="0" role="img"></span><br><small>自由欄3</small></th>
            <td><input type="text" data-param="free3" maxlength="20"></td>
          </tr>
          <tr data-seq="28">
            <th><span class="seq">28</span>free_csv<span class="info-icon" data-note-key="free_csv" tabindex="0" role="img"></span><br><small>フリー項目</small></th>
            <td><textarea data-param="free_csv" rows="3"></textarea></td>
          </tr>
        </tbody>
      </table>
    </fieldset>

    <fieldset id="detail-section">
      <legend>明細行（SEQ 29〜37）</legend>
      <p class="section-note">必要な件数分の明細を追加してください。空欄の項目は結果には含まれません。</p>
      <div id="detail-rows"></div>
      <button type="button" id="add-detail" class="secondary small">明細行を追加</button>
    </fieldset>

    <fieldset>
      <legend>リクエスト制御（SEQ 38〜40）</legend>
      <table>
        <tbody>
          <tr data-seq="38">
            <th><span class="seq">38</span>request_date<span class="info-icon" data-note-key="request_date" tabindex="0" role="img"></span><br><small>リクエスト日時</small></th>
            <td>
              <div class="stack">
                <input type="text" data-param="request_date" id="request-date" placeholder="YYYYMMDDHHMMSS" maxlength="14">
                <button type="button" id="set-now" class="secondary small">現在時刻をセット</button>
              </div>
              <p class="note">例：20240101153000（JST）。現在時刻を自動でセットできます。</p>
            </td>
          </tr>
          <tr data-seq="39">
            <th><span class="seq">39</span>limit_second<span class="info-icon" data-note-key="limit_second" tabindex="0" role="img"></span><br><small>リクエスト許容時間</small></th>
            <td><input type="number" data-param="limit_second" id="limit-second" min="0" placeholder="例：600"></td>
          </tr>
          <tr data-seq="40">
            <th><span class="seq">40</span>sps_hashcode<span class="info-icon" data-note-key="sps_hashcode" tabindex="0" role="img"></span><br><small>チェックサム</small></th>
            <td><input type="text" data-param="sps_hashcode" maxlength="40"></td>
          </tr>
        </tbody>
      </table>
    </fieldset>

    <div class="actions">
      <button type="submit">パラメータを生成</button>
      <button type="button" id="send-request">リクエスト送信</button>
      <button type="button" id="reset-form" class="secondary">リセット</button>
    </div>
  </form>

  <section class="result-card">
    <h2>整列済みパラメータ</h2>
    <div class="stack">
      <div>
        <table class="result-table">
          <thead>
            <tr><th>SEQ</th><th>パラメータ</th><th>値</th></tr>
          </thead>
          <tbody id="result-table"></tbody>
        </table>
      </div>
      <div>
        <h3>クエリ文字列</h3>
        <pre id="result-query"></pre>
        <button type="button" id="copy-query" class="secondary small">コピー</button>
      </div>
    </div>
  </section>

  <section class="helper-card">
    <h2>SHA-1 チェックサム支援</h2>
    <p class="note">フォームに入力済みの値（sps_hashcode を除く）を SEQ 順に連結し、末尾にシークレットキーを付けて UTF-8 へ変換し、SHA-1 を計算します。値の前後にある半角スペースは除去されます。購入結果（画面返却）のチェックサムは Shift-JIS で計算される点にご注意ください。</p>
    <div class="stack">
      <label class="inline-label">シークレットキー
        <input type="text" id="hash-secret" placeholder="加盟店シークレット">
      </label>
    </div>
    <div class="actions">
      <button type="button" id="calc-hash">ハッシュを計算</button>
      <button type="button" id="copy-hash" class="secondary small">チェックサムをコピー</button>
    </div>
    <h3>連結文字列</h3>
    <pre id="hash-string"></pre>
    <h3>SHA-1（16進）</h3>
    <pre id="hash-result"></pre>
  </section>

  <section class="helper-card">
    <h2>URL クエリ取り込み</h2>
    <p class="note">サンドボックスなどで取得したクエリ文字列を貼り付けてフォームへ反映できます。</p>
    <textarea id="import-query" rows="4" placeholder="example=foo&amount=100"></textarea>
    <div class="actions">
      <button type="button" id="apply-query" class="secondary">フォームに反映</button>
    </div>
  </section>
</main>

<template id="detail-template">
  <div class="detail-row">
    <h3><span class="detail-index"></span>件目</h3>
    <div class="detail-grid">
      <label class="inline-label">SEQ29 dtl_rowno<span class="info-icon" data-note-key="dtl_rowno" tabindex="0" role="img"></span>
        <input type="text" data-param="dtl_rowno" maxlength="3">
      </label>
      <label class="inline-label">SEQ30 dtl_item_id<span class="info-icon" data-note-key="dtl_item_id" tabindex="0" role="img"></span>
        <input type="text" data-param="dtl_item_id" maxlength="20">
      </label>
      <label class="inline-label">SEQ31 dtl_item_name<span class="info-icon" data-note-key="dtl_item_name" tabindex="0" role="img"></span>
        <input type="text" data-param="dtl_item_name" maxlength="40">
      </label>
      <label class="inline-label">SEQ32 dtl_item_count<span class="info-icon" data-note-key="dtl_item_count" tabindex="0" role="img"></span>
        <input type="number" data-param="dtl_item_count" min="0">
      </label>
      <label class="inline-label">SEQ33 dtl_tax<span class="info-icon" data-note-key="dtl_tax" tabindex="0" role="img"></span>
        <input type="number" data-param="dtl_tax" min="0">
      </label>
      <label class="inline-label">SEQ34 dtl_amount<span class="info-icon" data-note-key="dtl_amount" tabindex="0" role="img"></span>
        <input type="number" data-param="dtl_amount" min="0">
      </label>
      <label class="inline-label">SEQ35 dtl_free1<span class="info-icon" data-note-key="dtl_free1" tabindex="0" role="img"></span>
        <textarea data-param="dtl_free1" rows="2"></textarea>
      </label>
      <label class="inline-label">SEQ36 dtl_free2<span class="info-icon" data-note-key="dtl_free2" tabindex="0" role="img"></span>
        <textarea data-param="dtl_free2" rows="2"></textarea>
      </label>
      <label class="inline-label">SEQ37 dtl_free3<span class="info-icon" data-note-key="dtl_free3" tabindex="0" role="img"></span>
        <textarea data-param="dtl_free3" rows="2"></textarea>
      </label>
    </div>
    <button type="button" class="remove-detail">削除</button>
  </div>
</template>

<form id="submit-proxy" method="POST" action="https://stbfep.sps-system.com/f01/FepBuyInfoReceive.do" target="_blank" style="display: none;"></form>

<script>
  const PARAM_DEFS = [
    { seq: 1, name: 'pay_method' },
    { seq: 2, name: 'merchant_id' },
    { seq: 3, name: 'service_id' },
    { seq: 4, name: 'cust_code' },
    { seq: 5, name: 'sps_cust_no' },
    { seq: 6, name: 'sps_payment_no' },
    { seq: 7, name: 'order_id' },
    { seq: 8, name: 'item_id' },
    { seq: 9, name: 'pay_item_id' },
    { seq: 10, name: 'item_name' },
    { seq: 11, name: 'tax' },
    { seq: 12, name: 'amount' },
    { seq: 13, name: 'pay_type' },
    { seq: 15, name: 'service_type' },
    { seq: 20, name: 'terminal_type' },
    { seq: 21, name: 'success_url' },
    { seq: 22, name: 'cancel_url' },
    { seq: 23, name: 'error_url' },
    { seq: 24, name: 'pagecon_url' },
    { seq: 25, name: 'free1' },
    { seq: 26, name: 'free2' },
    { seq: 27, name: 'free3' },
    { seq: 28, name: 'free_csv' },
    { seq: 38, name: 'request_date' },
    { seq: 39, name: 'limit_second' },
    { seq: 40, name: 'sps_hashcode' }
  ];

  const DETAIL_DEFS = [
    { seq: 29, name: 'dtl_rowno' },
    { seq: 30, name: 'dtl_item_id' },
    { seq: 31, name: 'dtl_item_name' },
    { seq: 32, name: 'dtl_item_count' },
    { seq: 33, name: 'dtl_tax' },
    { seq: 34, name: 'dtl_amount' },
    { seq: 35, name: 'dtl_free1' },
    { seq: 36, name: 'dtl_free2' },
    { seq: 37, name: 'dtl_free3' }
  ];

  const REQUIREMENT_META = {
    required: { label: '必須', className: 'req-required', description: '必須項目です。' },
    conditional: { label: '条件付必須', className: 'req-conditional', description: '条件によって必須となる項目です。' },
    optional: { label: '任意', className: 'req-optional', description: '任意項目です。' }
  };

  const PARAM_REQUIREMENTS = {
    pay_method: 'conditional',
    merchant_id: 'required',
    service_id: 'required',
    cust_code: 'required',
    sps_cust_no: 'optional',
    sps_payment_no: 'optional',
    order_id: 'required',
    item_id: 'required',
    pay_item_id: 'optional',
    item_name: 'conditional',
    tax: 'conditional',
    amount: 'required',
    pay_type: 'required',
    service_type: 'required',
    terminal_type: 'optional',
    success_url: 'required',
    cancel_url: 'required',
    error_url: 'required',
    pagecon_url: 'required',
    free1: 'optional',
    free2: 'optional',
    free3: 'optional',
    free_csv: 'optional',
    dtl_rowno: 'conditional',
    dtl_item_id: 'conditional',
    dtl_item_name: 'conditional',
    dtl_item_count: 'conditional',
    dtl_tax: 'optional',
    dtl_amount: 'conditional',
    dtl_free1: 'optional',
    dtl_free2: 'optional',
    dtl_free3: 'optional',
    request_date: 'required',
    limit_second: 'optional',
    sps_hashcode: 'required'
  };

  const PARAM_NOTES = {
    pay_method: '支払方法を指定します。（複数指定可）',
    merchant_id: '当社で払い出します。',
    service_id: '当社で払い出します。',
    cust_code: 'マーチャント ID とサービス ID の組み合わせに対してユニーク（一意）な値としてください。決済情報保管時の紐付けキーとなるため、必ず顧客別に払い出してください。',
    sps_cust_no: '当連携モデルの場合は未設定（空文字）です。',
    sps_payment_no: '当連携モデルの場合は未設定（空文字）です。',
    order_id: 'マーチャント ID とサービス ID の組み合わせに対してユニーク（一意）な値としてください。※継続課金（簡易）の解約の場合も一意の ID を設定してください。',
    item_id: '',
    pay_item_id: '当連携モデルの場合は未設定（空文字）です。',
    item_name: '日本語、英数半角混在可能です。文字数オーバー時は切捨します。文字化け時は「？」に置換します。※設定されない場合は、購入内容確認画面において商品名の項目自体が表示されません。NP後払いの場合は必須項目となります。Pay-easy決済では以下の文字種は使用不可です。\n*(アスタリスク)、\n_(アンダーバー)、\n@(アットマーク)',
    tax: '0 円以上を設定してください。※総合振込決済のみ必須です。',
    amount: '0 円以上を設定してください。',
    pay_type: '',
    service_type: '',
    terminal_type: '省略の場合”0″を適用します。\n※詳細は基本仕様 要求の端末タイプの設定をご参照ください。',
    success_url: '',
    cancel_url: '',
    error_url: '',
    pagecon_url: 'SSL 通信が必須となります。',
    free1: '日本語、英数半角混在可能です。文字数オーバー時は切捨します。文字化け時は「？」に置換します。',
    free2: '日本語、英数半角混在可能です。文字数オーバー時は切捨します。文字化け時は「？」に置換します。',
    free3: '日本語、英数半角混在可能です。文字数オーバー時は切捨します。文字化け時は「？」に置換します。',
    free_csv: '決済固有タグ「free_csv」についてを参照ください。',
    dtl_rowno: '明細行を利用する場合は必須です。1ずつインクリメントさせてください。※明細行最大件数は 999 明細です。',
    dtl_item_id: '他明細内の明細商品 ID で、いずれか一つに設定されていた場合は、必須となります。',
    dtl_item_name: '日本語、英数半角混在可能です。文字数オーバー時は切捨します。文字化け時は「？」に置換します。他明細内の明細商品名称で、いずれか一つに設定されていた場合は、必須となります。NP後払いの場合は明細を設定する場合には必須項目となります。Pay-easy決済では以下の文字種は使用不可です。\n*(アスタリスク)、\n_(アンダーバー)、\n@(アットマーク)',
    dtl_item_count: '他明細内の明細数量で、いずれか一つに設定されていた場合は、必須となります。NP後払いの場合は明細を設定する場合には必須項目となります。',
    dtl_tax: '',
    dtl_amount: '他明細内の明細金額（税込）で、いずれか一つに設定されていた場合は、必須となります。NP後払いの場合は明細を設定する場合には必須項目となります。',
    dtl_free1: '※当社決済システムへの格納は行わない項目になります。ご利用の際は、当社営業にご確認下さい。',
    dtl_free2: '※当社決済システムへの格納は行わない項目になります。ご利用の際は、当社営業にご確認下さい。',
    dtl_free3: '※当社決済システムへの格納は行わない項目になります。ご利用の際は、当社営業にご確認下さい。',
    request_date: '本機能を加盟店がリクエストした日時です。',
    limit_second: '省略時は規定値（600）を適用します。',
    sps_hashcode: '基本仕様 チェックサム値の生成方法についてをご参照ください。'
  };

  const form = document.getElementById('request-form');
  const detailContainer = document.getElementById('detail-rows');
  const detailTemplate = document.getElementById('detail-template');
  const resultTable = document.getElementById('result-table');
  const resultQuery = document.getElementById('result-query');
  const hashString = document.getElementById('hash-string');
  const hashResult = document.getElementById('hash-result');
  const hashSecret = document.getElementById('hash-secret');
  const requestDateField = document.getElementById('request-date');
  const limitSecondField = document.getElementById('limit-second');

  document.getElementById('add-detail').addEventListener('click', () => addDetailRow());
  document.getElementById('reset-form').addEventListener('click', resetForm);
  document.getElementById('send-request').addEventListener('click', sendRequest);
  document.getElementById('set-now').addEventListener('click', () => {
    requestDateField.value = formatNow();
  });
  document.getElementById('copy-query').addEventListener('click', () => copyToClipboard(resultQuery.textContent));
  document.getElementById('calc-hash').addEventListener('click', calculateHash);
  document.getElementById('copy-hash').addEventListener('click', () => copyToClipboard(hashResult.textContent));
  document.getElementById('apply-query').addEventListener('click', applyQueryString);

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const params = collectParameters();
    renderResultTable(params);
    renderQuery(params);
  });

  function formatNow() {
    const now = new Date();
    const pad = (v) => String(v).padStart(2, '0');
    return [
      now.getFullYear(),
      pad(now.getMonth() + 1),
      pad(now.getDate()),
      pad(now.getHours()),
      pad(now.getMinutes()),
      pad(now.getSeconds())
    ].join('');
  }

  function applyTooltips(root = document) {
    root.querySelectorAll('.info-icon[data-note-key]').forEach((icon) => {
      const key = icon.dataset.noteKey;
      const note = Object.prototype.hasOwnProperty.call(PARAM_NOTES, key) ? PARAM_NOTES[key] : '';
      const message = note && note.trim() ? note : '備考情報はありません。';
      icon.textContent = 'i';
      icon.setAttribute('data-tooltip', message);
      icon.setAttribute('aria-label', message);
      icon.setAttribute('title', message);
      applyRequirementBadge(icon, key);
    });
  }

  function applyRequirementBadge(icon, key) {
    const requirementKey = Object.prototype.hasOwnProperty.call(PARAM_REQUIREMENTS, key)
      ? PARAM_REQUIREMENTS[key]
      : 'optional';
    const meta = Object.prototype.hasOwnProperty.call(REQUIREMENT_META, requirementKey)
      ? REQUIREMENT_META[requirementKey]
      : REQUIREMENT_META.optional;
    let badge = icon.parentNode.querySelector(`.requirement-badge[data-for="${key}"]`);
    if (!badge) {
      badge = document.createElement('span');
      badge.classList.add('requirement-badge');
      badge.dataset.for = key;
      icon.parentNode.insertBefore(badge, icon);
    }
    badge.textContent = meta.label;
    badge.classList.remove('req-required', 'req-conditional', 'req-optional');
    badge.classList.add(meta.className);
    badge.setAttribute('aria-label', meta.description);
    badge.setAttribute('title', meta.description);
  }

  function addDetailRow(defaults = {}) {
    const fragment = detailTemplate.content.cloneNode(true);
    detailContainer.appendChild(fragment);
    updateDetailRowIndexes();
    const insertedRow = detailContainer.lastElementChild;
    applyTooltips(insertedRow);
    insertedRow.querySelectorAll('[data-param]').forEach((input) => {
      const name = input.dataset.param;
      if (Object.prototype.hasOwnProperty.call(defaults, name)) {
        input.value = defaults[name];
      } else {
        input.value = '';
      }
    });
    insertedRow.querySelector('.remove-detail').addEventListener('click', () => {
      insertedRow.remove();
      updateDetailRowIndexes();
    });
    return insertedRow;
  }

  function updateDetailRowIndexes() {
    const rows = detailContainer.querySelectorAll('.detail-row');
    rows.forEach((row, index) => {
      row.dataset.index = String(index + 1);
      const label = row.querySelector('.detail-index');
      if (label) {
        label.textContent = index + 1;
      }
    });
  }

  function resetForm() {
    form.reset();
    detailContainer.innerHTML = '';
    resultTable.innerHTML = '';
    resultQuery.textContent = '';
    hashString.textContent = '';
    hashResult.textContent = '';
    requestDateField.value = formatNow();
    limitSecondField.value = '600';
    hashSecret.value = '';
    document.getElementById('import-query').value = '';
  }

  function collectParameters() {
    const params = [];
    for (const def of PARAM_DEFS) {
      const field = document.querySelector(`[data-param="${def.name}"]`);
      if (!field) continue;
      const value = (field.value ?? '').trim();
      if (value === '') continue;
      params.push({ ...def, value });
    }

    const detailRows = Array.from(detailContainer.querySelectorAll('.detail-row'));
    detailRows.forEach((row, rowIndex) => {
      DETAIL_DEFS.forEach((def) => {
        const field = row.querySelector(`[data-param="${def.name}"]`);
        if (!field) return;
        const value = (field.value ?? '').trim();
        if (value === '') return;
        params.push({ seq: def.seq, name: def.name, value, detailIndex: rowIndex + 1 });
      });
    });

    params.sort((a, b) => {
      if (a.seq === b.seq) {
        const ai = a.detailIndex ?? 0;
        const bi = b.detailIndex ?? 0;
        return ai - bi;
      }
      return a.seq - b.seq;
    });

    return params;
  }

  function renderResultTable(params) {
    resultTable.innerHTML = '';
    params.forEach((param) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${param.seq}</td><td>${escapeHtml(param.name)}</td><td>${escapeHtml(param.value)}</td>`;
      resultTable.appendChild(tr);
    });
  }

  function renderQuery(params) {
    const query = params
      .map((param) => `${encodeURIComponent(param.name)}=${encodeURIComponent(param.value)}`)
      .join('&');
    resultQuery.textContent = query;
  }

  function sendRequest() {
    const params = collectParameters();
    if (params.length === 0) {
      alert('送信するパラメータがありません。');
      return;
    }

    const proxyForm = document.getElementById('submit-proxy');
    proxyForm.innerHTML = '';

    params.forEach((param) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = param.name;
      input.value = param.value;
      proxyForm.appendChild(input);
    });

    proxyForm.requestSubmit();
  }

  async function calculateHash() {
    const secret = hashSecret.value || '';
    const params = collectParameters().filter((param) => param.name !== 'sps_hashcode');
    const base = params.map((param) => param.value).join('') + secret;
    hashString.textContent = base;

    if (!window.crypto || !window.crypto.subtle) {
      hashResult.textContent = 'このブラウザでは SubtleCrypto が利用できません。';
      return;
    }

    const encoder = new TextEncoder();
    const data = encoder.encode(base);
    try {
      const digest = await window.crypto.subtle.digest('SHA-1', data);
      hashResult.textContent = toHexString(new Uint8Array(digest));
    } catch (error) {
      hashResult.textContent = `ハッシュ計算に失敗しました: ${error.message ?? error}`;
    }
  }

  function toHexString(bytes) {
    return Array.from(bytes)
      .map((b) => b.toString(16).padStart(2, '0'))
      .join('');
  }

  function applyQueryString() {
    const raw = (document.getElementById('import-query').value || '').trim();
    if (!raw) return;
    const query = raw.startsWith('?') ? raw.slice(1) : raw;
    const params = new URLSearchParams(query);

    const detailValues = new Map();

    params.forEach((value, key) => {
      if (DETAIL_DEFS.some((def) => def.name === key)) {
        if (!detailValues.has(key)) {
          detailValues.set(key, []);
        }
        detailValues.get(key).push(value);
      } else {
        const field = document.querySelector(`[data-param="${key}"]`);
        if (field) {
          field.value = value;
        }
      }
    });

    detailContainer.innerHTML = '';

    if (detailValues.size > 0) {
      const lengths = Array.from(detailValues.values()).map((values) => values.length);
      const maxLength = lengths.length ? Math.max(...lengths) : 0;
      for (let i = 0; i < maxLength; i += 1) {
        const defaults = {};
        DETAIL_DEFS.forEach((def) => {
          const list = detailValues.get(def.name);
          if (list && list[i] !== undefined) {
            defaults[def.name] = list[i];
          }
        });
        addDetailRow(defaults);
      }
    }
  }

  function copyToClipboard(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    const temp = document.createElement('textarea');
    temp.value = text;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
  }

  function escapeHtml(value) {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/\n/g, '<br>');
  }

  // 初期化
  applyTooltips(document);
  resetForm();
</script>
</body>
</html>
